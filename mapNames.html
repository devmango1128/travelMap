<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>지도깨기 - 대한민국, 어디까지 가봤니?</title>
        <link rel="stylesheet" href="src/css/index.css" />
    </head>
    <body>
        <div class="header-container">
            <span onclick="goMenu('mapNames.html')">지도깨기</span>
            <img src="src/images/menu_icon.png" class="menu" onclick="goMenu('menu.html')"/>
        </div>
        <div class="map-names-container" id="mapNames"></div>
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="src/js/index.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', async function() {
                const db = await openIndexedDB("MapColorDB", 1);
                const allDatas = await getAllData(db, "mapNames");

                if(allDatas && !allDatas.length) window.location.href = "mapName.html";

                const mapNamesContainer = document.getElementById("mapNames");
                const sigunguData = await fetchJSON();

                allDatas.forEach((data) => {
                    const div = document.createElement("div");
                    div.className = 'name-box';

                    const titDiv = document.createElement("div");
                    titDiv.innerHTML = data.mapName +  '<span class="tit-modify"></span>'
                    titDiv.className = 'tit-name';

                    div.appendChild(titDiv);

                    const menuDiv = document.createElement("div");
                    menuDiv.textContent = '...';
                    menuDiv.addEventListener('click', (event) => {
                        const menuArea = document.createElement("div");
                        menuArea.className = 'menu-area';
                        menuArea.innerHTML = '<div class="color-area">' +
                            '<div class="circle mr10" style="background-color: #3496ff;" onclick="colorChange(addEventListener(), \'#3496ff\')"></div>' +
                            '<div class="circle mr10" style="background-color: #ff8e00;" onclick="colorChange(addEventListener(), \'#ff8e00\')"></div>' +
                            '<div class="circle mr10" style="background-color: #7b34ff;" onclick="colorChange(addEventListener(), \'#7b34ff\')"></div>' +
                            '<div class="circle" style="background-color: #34b37e;" onclick="colorChange(addEventListener(), \'#34b37e\')"></div>' +
                            '</div>' +
                            '<div id="deleteMapNm" class="delete-map-nm">삭제하기</div>';

                        menuDiv.appendChild(menuArea);
                    });
                    menuDiv.className = 'menu-div';

                    div.appendChild(menuDiv);

                    const hrDiv = document.createElement("div");
                    hrDiv.className = 'hr-div';

                    div.appendChild(hrDiv);

                    const imgDiv = document.createElement("div");
                    imgDiv.className = 'img-div';

                    const img = document.createElement("img");
                    img.src = 'src/images/pin.png';
                    img.className = 'pin';
                    imgDiv.appendChild(img);

                    const filteredItems = allDatas.filter(item => item.mapName === data.mapName);

                    const uniqueSigunguSet = filteredItems.reduce((acc, current) => {
                        const key = current.data ? current.data.sigunguCd : '';
                        if (key && !acc.has(key)) {
                            acc.add(key);
                        }
                        return acc;
                    }, new Set());

                    const pointCnt = uniqueSigunguSet.size;

                    const count = document.createElement("div");
                    count.innerHTML = '<span>' + sigunguData.features.length + '개의 지역 중 </span><span class="point-cnt">' + pointCnt + '</span><span>개를 </span><span class="point">정복</span><span>했어요!</span>';
                    count.className = 'count';
                    imgDiv.appendChild(count);

                    div.appendChild(imgDiv);

                    const progPer = (pointCnt / sigunguData.features.length) * 100;

                    const progress = document.createElement("div");
                    progress.className = 'progress-container';

                    const bar = document.createElement("div");
                    bar.className = 'progress-bar';
                    bar.style.width = `${progPer}%`;
                    progress.appendChild(bar);

                    div.appendChild(progress);

                    const imgDiv2 = document.createElement("div");
                    imgDiv2.className = 'img-div';

                    const img2 = document.createElement("img");
                    img2.src = 'src/images/walk.png';
                    img2.className = 'walkman';
                    imgDiv2.appendChild(img2);

                    const visit = document.createElement("div");
                    const visitNm = '서울시';
                    if(true) {
                        visit.innerHTML = '<span>제일 많이 방문한 지역은 </span><span class="point-walk">' + visitNm + '</span><span>예요 :)</span>';
                    } else {
                        visit.innerHTML = '<span>아직 방문한 지역이 없네요 :(</span>';
                    }
                    visit.className = 'visit';
                    imgDiv2.appendChild(visit);

                    div.appendChild(imgDiv2);

                    const imgDiv3 = document.createElement("div");
                    imgDiv3.className = 'img-div';

                    const totalDiv = document.createElement("div");
                    totalDiv.textContent = '전체보기';
                    totalDiv.addEventListener('click', (event) => {
                        console.log('전체보기')
                    });
                    totalDiv.className = 'total-btn-div';

                    imgDiv3.appendChild(totalDiv);

                    const mapDiv = document.createElement("div");
                    mapDiv.textContent = '지도보기';
                    mapDiv.addEventListener('click', (event) => {
                        console.log('지도보기')
                    });
                    mapDiv.className = 'map-btn-div';

                    imgDiv3.appendChild(mapDiv);

                    const timeDiv = document.createElement("div");
                    timeDiv.textContent = '타임라인';
                    timeDiv.addEventListener('click', (event) => {
                        console.log('타임라인보기')
                    });
                    timeDiv.className = 'time-btn-div';

                    imgDiv3.appendChild(timeDiv);

                    const regDiv = document.createElement("div");
                    regDiv.addEventListener('click', () => mapNamesNextPage(data.mapName));
                    regDiv.className = 'reg-btn-div';

                    imgDiv3.appendChild(regDiv);

                    div.appendChild(imgDiv3);

                    mapNamesContainer.appendChild(div);
                });
            });

            function mapNamesNextPage(mapName) {
                nextPage(1, mapName);
            }

            function colorChange(e, mapName) {
                e.stopPropagation();
               console.log(e.target);
               console.log(mapName)
            }
        </script>
    </body>
</html>
