<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Korean Administrative Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            margin: 0 auto;
            padding: 0;
            background: #75c8f3; /* 배경을 파란색으로 설정 */
        }
        #map {
            height: 90vh;
            background: #75c8f3; /* 지도 배경을 파란색으로 설정 */
        }
        .leaflet-container {
            background: #75c8f3; /* 지도 컨테이너의 배경을 파란색으로 설정 */
        }
        .form-container {
            padding: 10px;
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .form-container select, .form-container input, .form-container textarea, .form-container button {
            margin-right: 10px;
        }
        .location-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>
<div class="form-container">
    <select name="sidoCd" size="1" class="input_text" id="citySelect" onchange="updateDistricts()">
        <option value="*">시/도 선택</option>
        <option value="11">서울특별시</option>
        <option value="26">부산광역시</option>
        <option value="27">대구광역시</option>
        <option value="28">인천광역시</option>
        <option value="29">광주광역시</option>
        <option value="30">대전광역시</option>
        <option value="31">울산광역시</option>
        <option value="36">세종특별자치시</option>
        <option value="41">경기도</option>
        <option value="43">충청북도</option>
        <option value="44">충청남도</option>
        <option value="46">전라남도</option>
        <option value="47">경상북도</option>
        <option value="48">경상남도</option>
        <option value="50">제주특별자치도</option>
        <option value="51">강원특별자치도</option>
        <option value="52">전북특별자치도</option>
    </select>
    <select id="districtSelect">
        <option value="">구 선택</option>
        <!-- 구 옵션들 -->
    </select>
    <input type="color" id="colorPicker" />
    <input type="text" id="datePicker" placeholder="날짜 선택" />
    <textarea id="description" placeholder="설명을 입력하세요"></textarea>
    <button onclick="saveRegion()">등록</button>
</div>
<button class="location-btn" id="locationButton" onclick="moveToCurrentLocation()">현재 위치로 이동</button>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // IndexedDB 초기화
    var db;
    var request = indexedDB.open("RegionsDB", 1);

    request.onerror = function(event) {
        console.error("Database error: " + event.target.errorCode);
    };

    request.onsuccess = function(event) {
        db = event.target.result;
        loadGeoJSON(); // 데이터베이스가 열렸을 때 지역 정보 불러오기
    };

    request.onupgradeneeded = function(event) {
        db = event.target.result;
        var objectStore = db.createObjectStore("regions", { keyPath: "region" });
        console.log("Object store created");
    };

    function initMap() {
        map = L.map('map', {
            center: [37.5665, 126.9780], // 대한민국 중심 좌표
            zoom: 7,
            crs: L.CRS.EPSG3857, // 좌표 참조 시스템 설정
            zoomControl: true, // 줌 컨트롤 활성화
            attributionControl: false, // 저작권 정보 비활성화
            layers: [] // 빈 타일 레이어 제거
        });

        // 흰색 배경을 설정합니다.
        var whiteBackground = L.tileLayer('', {
            attribution: '',
            maxZoom: 18
        });

        whiteBackground.getContainer = function() {
            var container = document.createElement('div');
            container.style.background = '#75c8f3'; // 배경을 파란색으로 설정
            container.style.width = '100%';
            container.style.height = '100%';
            return container;
        };

        whiteBackground.addTo(map);
    }

    var regions = {}; // 지역별 정보 저장
    var geojsonLayer;

    flatpickr("#datePicker", { dateFormat: "Y-m-d" });

    // 시/도와 구 데이터 로드
    var cities = {};
    var districtToCity = {};

    // 시/도와 구 데이터 로드
    function loadCityDistrictData() {
        $.getJSON("src/data/sigungu.json", function(data) {
            data.features.forEach(function(feature) {
                var cityCode = feature.properties.CTPRVN_CD;
                var city = ''; // 시/도 이름 초기화
                var options = document.getElementById('citySelect').options;

                // cityCode와 일치하는 citySelect의 텍스트 값을 가져옴
                for (var i = 0; i < options.length; i++) {
                    if (options[i].value === cityCode) {
                        city = options[i].text;
                        break;
                    }
                }

                var districtCode = feature.properties.SIG_CD;
                var district = feature.properties.SIG_KOR_NM;

                if (!cities[cityCode]) {
                    cities[cityCode] = { name: city, districts: [] };
                }
                if (districtCode.startsWith(cityCode)) {
                    cities[cityCode].districts.push({ code: districtCode, name: district });
                }
                districtToCity[districtCode] = city;
            });
        });
    }


    // 구 옵션 업데이트
    function updateDistricts() {
        var districtSelect = document.getElementById('districtSelect');
        districtSelect.innerHTML = '<option value="">구 선택</option>';
        var selectedCityCode = document.getElementById('citySelect').value;

        $.getJSON("src/data/sigungu.json", function(data) {
            data.features.forEach(function (feature) {
                if (feature.properties.SIG_CD.startsWith(selectedCityCode)) {
                    var option = document.createElement('option');
                    option.value = feature.properties.SIG_CD;
                    option.textContent = feature.properties.SIG_KOR_NM;
                    districtSelect.appendChild(option);
                }
            });
        });
    }

    // GeoJSON 파일 로드 및 시군구 단위로 필터링
    function loadGeoJSON() {
        $.getJSON("src/data/sigungu.json", function(data) {
            // 시군구 단위로 필터링된 GeoJSON 데이터 생성
            var mergedFeatures = {};

            data.features.forEach(function(feature) {
                var sgg = feature.properties.SIG_CD;
                if (!mergedFeatures[sgg]) {
                    mergedFeatures[sgg] = {
                        type: "Feature",
                        properties: feature.properties,
                        geometry: {
                            type: "MultiPolygon",
                            coordinates: []
                        }
                    };
                }
                mergedFeatures[sgg].geometry.coordinates.push(feature.geometry.coordinates);
            });

            var filteredData = {
                type: "FeatureCollection",
                features: Object.values(mergedFeatures)
            };

            // GeoJSON 레이어 생성
            geojsonLayer = L.geoJson(filteredData, {
                style: function (feature) {
                    return {
                        color: "#282727",
                        weight: 1,
                        fillColor: "#ffffff", // 지도 영역을 흰색으로 설정
                        fillOpacity: 1
                    };
                },
                onEachFeature: function (feature, layer) {
                    layer.on({
                        click: function (e) {
                            var districtSelect = document.getElementById('districtSelect');
                            districtSelect.value = feature.properties.SIG_CD;
                            console.log(regions[feature.properties.SIG_CD.substring(0, 2) + feature.properties.SIG_CD])
                            var popupContent = "<b>" + feature.properties.SIG_KOR_NM + "</b><br>" +
                                "날짜: " + (regions[feature.properties.SIG_CD.substring(0, 2) +feature.properties.SIG_CD] ? regions[feature.properties.SIG_CD.substring(0, 2) +feature.properties.SIG_CD][0].date : "") + "<br>" +
                                "설명: " + (regions[feature.properties.SIG_CD.substring(0, 2) +feature.properties.SIG_CD] ? regions[feature.properties.SIG_CD.substring(0, 2) +feature.properties.SIG_CD][0].description : "");
                            layer.bindPopup(popupContent).openPopup();
                        }
                    });
                }
            }).addTo(map);

            loadRegions(); // geojsonLayer가 정의된 후에 호출
        });
    }

    // 지역 정보 저장
    function saveRegion() {
        var cityCode = document.getElementById('citySelect').value;
        var districtCode = document.getElementById('districtSelect').value;
        var region = cityCode + districtCode;
        var color = document.getElementById('colorPicker').value;
        var date = document.getElementById('datePicker').value;
        var description = document.getElementById('description').value;

        if (!cityCode || !districtCode || !color || !date || !description) {
            alert("모든 필드를 입력하세요!");
            return;
        }

        if (!regions[region]) {
            regions[region] = [];
        }
        regions[region].push({ color: color, date: date, description: description });

        geojsonLayer.eachLayer(function(layer) {
            if (layer.feature.properties.SIG_CD === districtCode) {
                layer.setStyle({
                    fillColor: color,
                    fillOpacity: 0.7
                });
            }
        });

        saveRegions();
    }

    // 지역 정보 IndexedDB에 저장
    function saveRegions() {
        var transaction = db.transaction(["regions"], "readwrite");
        var objectStore = transaction.objectStore("regions");
        Object.keys(regions).forEach(function(region) {
            objectStore.put({ region: region, data: regions[region] });
        });

        transaction.oncomplete = function() {
            console.log("All regions have been saved successfully.");
        };

        transaction.onerror = function(event) {
            console.error("Transaction error: " + event.target.errorCode);
        };
    }

    // 지역 정보 불러오기
    function loadRegions() {
        var transaction = db.transaction(["regions"], "readonly");
        var objectStore = transaction.objectStore("regions");
        var request = objectStore.getAll();

        request.onsuccess = function(event) {

            var results = event.target.result;
            results.forEach(function(item) {
                regions[item.region] = item.data;
            });

            if (geojsonLayer) { // geojsonLayer가 정의된 후에 실행
                geojsonLayer.eachLayer(function(layer) {
                    var districtCode = layer.feature.properties.SIG_CD; // 구 코드 가져오기
                    var region = districtCode.substring(0, 2) + districtCode; // 시 + 구 이름으로 key 생성
                    console.log('region', region);
                    if (regions[region]) {
                        var color = regions[region][0].color;
                        layer.setStyle({
                            fillColor: color,
                            fillOpacity: 0.7
                        });
                    }
                });
            }
        };

        request.onerror = function(event) {
            console.error("Error loading regions from IndexedDB: " + event.target.errorCode);
        };
    }

    // 현재 위치로 이동
    function moveToCurrentLocation() {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                map.setView([position.coords.latitude, position.coords.longitude], 12);
            },
            function(error) {
                console.error("Error Code = " + error.code + " - " + error.message);
                map.setView([37.5665, 126.9780], 7); // 대한민국 중심 좌표로 이동
            }
        );
    }

    // GeoJSON 로드 및 초기 설정
    document.addEventListener('DOMContentLoaded', function() {
        initMap();
        loadCityDistrictData();
        loadGeoJSON();
    });
</script>
</body>
</html>
